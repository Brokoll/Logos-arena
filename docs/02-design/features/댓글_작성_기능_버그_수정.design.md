---
template: design
version: 1.2
description: PDCA Design phase document template (between Plan and Do) with Clean Architecture and Convention support
variables:
  - feature: Feature name
  - date: Creation date (YYYY-MM-DD)
  - author: Author
  - project: Project name (from package.json or GEMINI.md)
  - version: Project version (from package.json)
---

# 댓글 작성 기능 버그 수정 Design Document

> **Summary**: 댓글 포스트 버튼 클릭 시 댓글이 작성되지 않고 UI가 업데이트되지 않는 버그를 수정합니다.
>
> **Project**: logos-arena
> **Version**: 0.1.0
> **Author**: Gemini CLI
> **Date**: 2026-02-06
> **Status**: Draft
> **Planning Doc**: [댓글_작성_기능_버그_수정.plan.md](../01-plan/features/댓글_작성_기능_버그_수정.plan.md)

### Pipeline References (if applicable)

| Phase | Document | Status |
|-------|----------|--------|
| Phase 1 | [Schema Definition](../01-plan/schema.md) | N/A |
| Phase 2 | [Coding Conventions](../01-plan/conventions.md) | N/A |
| Phase 3 | [Mockup](../02-design/mockup/{feature}.md) | N/A |
| Phase 4 | [API Spec](../02-design/api/{feature}.md) | N/A |

---

## 1. Overview

### 1.1 Design Goals

- 댓글 작성 시 데이터베이스에 정확하게 저장되도록 합니다.
- 댓글 제출 후 사용자 인터페이스가 즉시 새로운 댓글을 반영하도록 합니다.
- 백엔드 또는 프론트엔드에서 발생하는 오류를 사용자에게 명확하게 전달합니다.

### 1.2 Design Principles

- **단일 책임 원칙 (Single Responsibility Principle)**: 각 컴포넌트나 함수는 하나의 책임만 갖도록 설계합니다.
- **관심사 분리 (Separation of Concerns)**: UI, 비즈니스 로직, 데이터 접근 로직을 명확히 분리합니다.
- **사용자 경험 중심 (User-centric experience)**: 댓글 제출 과정에서 사용자에게 명확한 피드백(로딩, 성공, 실패)을 제공합니다.

---

## 2. Architecture

### 2.1 Component Diagram

```
┌─────────────────────────────────┐
│     Client (Browser)            │
│ ┌───────────────────────────┐   │
│ │ src/app/debate/[id]/page.tsx│───┐
│ │ (Debate Detail Page)      │   │
│ └───────────────────────────┘   │
│              │                    │
│ ┌───────────────────────────┐   │
│ │ src/components/arena/     │   │
│ │   ArenaFeed.tsx           │───┤
│ │ (Displays Comments)       │   │
│ └───────────────────────────┘   │
│              │                    │
│ ┌───────────────────────────┐   │
│ │   ArgumentForm.tsx        │───┼──▶ Call Server Action (Post Comment)
│ │ (Comment Input Form)      │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
              │ (Server Action)
              ▼
┌─────────────────────────────────┐
│      Server (Next.js)           │
│ ┌───────────────────────────┐   │
│ │ src/app/actions.ts        │───┼──▶ Interact with Supabase
│ │ (Server Actions for Data) │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
              │ (Supabase Client/Server)
              ▼
┌─────────────────────────────────┐
│      Database (Supabase)        │
│ ┌───────────────────────────┐   │
│ │ src/lib/supabase/client.ts│   │
│ │ src/lib/supabase/server.ts│───┼──▶ Store/Retrieve Comment Data
│ │ supabase/schema.sql       │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
```

### 2.2 Data Flow

```
User Input (ArgumentForm)
   │
   ▼
Submit Form (ArgumentForm calls Server Action in actions.ts)
   │
   ▼
Server Action (actions.ts)
   │ Validates input, interacts with Supabase
   ▼
Supabase (Database)
   │ Inserts new comment
   ▼
Server Action returns new comment data or error
   │
   ▼
UI Update (page.tsx re-renders, potentially using revalidatePath or optimistic updates)
   │
   ▼
New Comment Displayed (ArenaFeed, ArgumentItem)
```

### 2.3 Dependencies

| Component | Depends On | Purpose |
|-----------|-----------|---------|
| `ArgumentForm.tsx` | `actions.ts` | 댓글 데이터 제출 |
| `page.tsx` (debate detail) | `ArenaFeed.tsx` | 댓글 목록 표시 |
| `ArenaFeed.tsx` | `ArgumentItem.tsx` | 개별 댓글 렌더링 |
| `actions.ts` | `src/lib/supabase/server.ts` | 서버 측 Supabase 상호작용 |
| `actions.ts` | `src/lib/database.types.ts`, `src/lib/schemas.ts` | 데이터 유효성 검사 및 타입 정의 |

---

## 3. Data Model

### 3.1 Entity Definition

```typescript
// Comment
// src/lib/database.types.ts 또는 src/types/comment.ts 에 정의될 예정
interface Comment {
  id: string;           // UUID
  created_at: string;      // ISO 8601 형식의 생성 타임스탬프 (Date 객체 대신 string으로 처리)
  user_id: string;      // 사용자 ID (Foreign key to auth.users.id)
  debate_id: string;    // 토론 ID (Foreign key to debates.id)
  content: string;      // 댓글 내용
  // ... 필요 시 다른 필드 추가 (예: parent_comment_id, likes 등)
}
```

### 3.2 Entity Relationships

```
[Users] 1 ──── N [Comments]
   │
   └── 1 ──── N [Debates]
```
(여기서 Comment는 Users와 Debates 테이블 모두에 N-1 관계로 연결됩니다.)

### 3.3 Database Schema (if applicable)

Supabase `schema.sql` 또는 `reset_and_update.sql` 파일에 `comments` 테이블이 정의되어 있을 것으로 예상합니다. 없을 경우 추가해야 합니다.

```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  debate_id UUID REFERENCES debates(id) NOT NULL,
  content TEXT NOT NULL
);

ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can insert their own comments."
ON comments FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view comments."
ON comments FOR SELECT USING (TRUE);
```
(이는 가상의 스키마이며, 실제 스키마를 확인하여 수정해야 합니다.)

---

## 4. API Specification

전통적인 REST API 엔드포인트 대신 Next.js 서버 액션을 활용합니다. `src/app/actions.ts` 파일 내에 댓글 관련 서버 액션 함수를 정의하거나 수정합니다.

#### `addComment(formData: FormData)` (Server Action in `src/app/actions.ts`)

**Function Signature:**
```typescript
async function addComment(formData: FormData): Promise<{ data?: Comment; error?: string }> {
  // ... implementation
}
```

**Request Payload (from `formData`):**
- `debateId`: string (토론 ID)
- `content`: string (댓글 내용)
- `userId`: string (현재 로그인한 사용자 ID, 서버 측에서 가져오거나 검증)

**Response (Success - 200 OK equivalent):**
```typescript
{
  data: {
    id: "uuid-of-new-comment",
    created_at: "2026-02-06T12:00:00Z",
    user_id: "uuid-of-user",
    debate_id: "uuid-of-debate",
    content: "새로운 댓글 내용"
  }
}
```

**Response (Error - 4xx/5xx equivalent):**
```typescript
{
  error: "댓글 작성에 실패했습니다: [에러 메시지]"
}
```

---

## 5. UI/UX Design

### 5.1 Screen Layout

현재 토론 상세 페이지(`src/app/debate/[id]/page.tsx`)의 레이아웃을 유지합니다. `ArgumentForm.tsx`가 댓글 입력 영역으로, `ArenaFeed.tsx`가 기존 댓글 목록으로 작동합니다.

### 5.2 User Flow

```
토론 상세 페이지 진입
   │
   ▼
댓글 입력 필드에 내용 작성 (ArgumentForm)
   │
   ▼
'Post' 또는 'Submit' 버튼 클릭
   │
   ▼ (Server Action 호출)
'Posting...' 또는 로딩 스피너 표시
   │
   ▼ (Server Action 응답 대기)
성공 시:
   - 입력 필드 초기화
   - 새 댓글이 댓글 목록 (ArenaFeed) 상단에 즉시 추가되어 표시
   - '댓글이 성공적으로 작성되었습니다.' 토스트 메시지 (선택 사항)
   │
   ▼
실패 시:
   - 오류 메시지 (ArgumentForm 근처 또는 토스트 메시지) 표시
   - 입력 필드 내용 유지 또는 초기화 (사용자 선택)
```

### 5.3 Component List

| Component | Location | Responsibility | Notes |
|-----------|----------|----------------|-------|
| `page.tsx` | `src/app/debate/[id]/` | 토론 상세 페이지 렌더링, 댓글 데이터 초기 로딩 및 업데이트 트리거 | `ArenaFeed`와 `ArgumentForm`을 포함 |
| `ArenaFeed.tsx` | `src/components/arena/` | 댓글 목록을 표시하고, 새 댓글을 추가하여 렌더링 | 댓글 리스트를 `state`로 관리하거나 `revalidatePath`를 통해 갱신 |
| `ArgumentForm.tsx` | `src/components/arena/` | 댓글 입력 폼, 제출 버튼, 로딩/에러 상태 표시 | `addComment` Server Action 호출 |
| `ArgumentItem.tsx` | `src/components/arena/` | 개별 댓글 내용 및 사용자 정보 렌더링 | |

---

## 6. Error Handling

### 6.1 Error Code Definition

| Code | Message | Cause | Handling |
|------|---------|-------|----------|
| `COMMENT_EMPTY` | 댓글 내용을 입력해주세요. | 클라이언트 측: 빈 댓글 제출 | `ArgumentForm`에서 유효성 검사 후 메시지 표시 |
| `UNAUTHENTICATED` | 로그인 후 댓글을 작성할 수 있습니다. | 서버 측: 비로그인 사용자 댓글 시도 | `actions.ts`에서 사용자 세션 확인 후 오류 반환, 클라이언트에서 로그인 페이지로 리디렉션 유도 |
| `INVALID_DEBATE_ID` | 유효하지 않은 토론 ID입니다. | 서버 측: 존재하지 않는 토론에 댓글 시도 | `actions.ts`에서 토론 존재 여부 확인 후 오류 반환 |
| `DB_INSERT_FAILED` | 댓글 저장에 실패했습니다. | 서버 측: Supabase 데이터 삽입 실패 | `actions.ts`에서 Supabase 응답 확인 후 오류 반환 |
| `UNKNOWN_ERROR` | 알 수 없는 오류가 발생했습니다. | 예상치 못한 서버 또는 네트워크 오류 | `actions.ts` 또는 클라이언트 측에서 일반 오류 메시지 표시 |

### 6.2 Error Response Format

서버 액션은 `{ error: string }` 형식으로 오류 메시지를 반환합니다. 클라이언트(`ArgumentForm.tsx`)는 이를 받아 사용자에게 표시합니다.

---

<h2>7. Security Considerations</h2>

- [x] **인증/인가 처리**: `actions.ts`에서 Supabase의 `auth.uid()`를 사용하여 현재 로그인한 사용자의 ID를 확인하고, 해당 사용자만 댓글을 작성할 수 있도록 합니다 (Row Level Security).
- [x] **입력 유효성 검사**: 댓글 내용(`content`)에 대한 길이 제한 및 잠재적인 XSS 공격 방지를 위한 이스케이프 처리를 고려합니다. Next.js의 서버 컴포넌트 환경에서는 `DOMPurify`와 같은 라이브러리를 사용하기 어려울 수 있으므로, 서버 측에서 데이터베이스 저장 전에 적절한 검증/정화 로직을 적용합니다.
- [ ] **비공개 정보 노출 방지**: 댓글 내용에 사용자나 토론의 민감한 정보가 포함되지 않도록 주의합니다.

---

<h2>8. Test Plan</h2>

<h3>8.1 Test Scope</h3>

| Type | Target | Tool |
|------|--------|------|
| 단위 테스트 | `actions.ts` 내 댓글 추가 로직, 유효성 검사 함수 | Jest/Vitest (프로젝트에 Jest/Vitest가 있다면 사용) |
| 통합 테스트 | `ArgumentForm.tsx`에서 댓글 제출 -> `actions.ts` -> Supabase -> `page.tsx` UI 업데이트 | Playwright (E2E 테스트로 대체 가능) |
| E2E 테스트 | 사용자 시나리오: 로그인 -> 토론 페이지 이동 -> 댓글 작성 -> 댓글 목록에서 확인 | Playwright |

<h3>8.2 Test Cases (Key)</h3>

- [ ] Happy path: 로그인한 사용자가 유효한 댓글을 작성하고 성공적으로 제출하여 UI에 표시됨.
- [ ] Error scenario:
    - 비로그인 사용자가 댓글 제출 시도 시 오류 메시지 표시.
    - 빈 댓글 제출 시도 시 오류 메시지 표시.
    - 데이터베이스 저장 실패 시 오류 메시지 표시.
- [ ] Edge case: 매우 긴 댓글 작성 시도 (길이 제한 확인).

---

<h2>9. Clean Architecture</h2>

프로젝트는 "Dynamic" 레벨 아키텍처를 따르는 것으로 보입니다.

<h3>9.1 Layer Structure</h3>

| Layer | Responsibility | Location |
|-------|---------------|----------|
| **Presentation** | UI 컴포넌트, 페이지 | `src/app/debate/[id]/page.tsx`, `src/components/arena/` |
| **Application** | 유스케이스, 비즈니스 로직 오케스트레이션 | `src/app/actions.ts` (서버 액션) |
| **Domain** | 엔티티, 타입, 핵심 비즈니스 규칙 | `src/lib/database.types.ts`, `src/lib/schemas.ts` |
| **Infrastructure** | API 클라이언트, DB, 외부 서비스 | `src/lib/supabase/client.ts`, `src/lib/supabase/server.ts` |

<h3>9.2 Dependency Rules</h3>

```
┌─────────────────────────────────────────────────────────────┐
│                    Dependency Direction                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Presentation ──→ Application ──→ Domain ←── Infrastructure│
│                          │                                  │
│                          └──→ Infrastructure                │
│                                                             │
│   Rule: Inner layers MUST NOT depend on outer layers        │
│         Domain is independent (no external dependencies)    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

<h3>9.3 File Import Rules</h3>

기존 프로젝트의 import 규칙을 따릅니다.

<h3>9.4 This Feature's Layer Assignment</h3>

| Component | Layer | Location |
|-----------|-------|----------|
| `page.tsx` | Presentation | `src/app/debate/[id]/` |
| `ArgumentForm.tsx` | Presentation | `src/components/arena/` |
| `ArenaFeed.tsx` | Presentation | `src/components/arena/` |
| `actions.ts` | Application | `src/app/` |
| `database.types.ts` | Domain | `src/lib/` |
| `schemas.ts` | Domain | `src/lib/` |
| `supabase/client.ts` | Infrastructure | `src/lib/supabase/` |
| `supabase/server.ts` | Infrastructure | `src/lib/supabase/` |

---

<h2>10. Coding Convention Reference</h2>

> 참고: `GEMINI.md`, `.eslintrc.json`, `tsconfig.json` 파일

<h3>10.1 Naming Conventions</h3>

기존 프로젝트의 컨벤션을 따릅니다. (`.eslintrc.json`, `tsconfig.json` 존재)

<h3>10.2 Import Order</h3>

기존 프로젝트의 컨벤션을 따릅니다.

<h3>10.3 Environment Variables</h3>

댓글 기능 자체를 위한 새로운 환경 변수는 필요 없지만, Supabase 연결을 위한 기존 환경 변수들이 올바르게 설정되어 있어야 합니다.

| Prefix | Purpose | Scope | Example |
|--------|---------|-------|---------|
| `NEXT_PUBLIC_` | Client-side accessible | Browser | `NEXT_PUBLIC_SUPABASE_URL` |
| `DB_` | Database connections | Server only | `SUPABASE_URL` (또는 `DATABASE_URL`) |
| `AUTH_` | Authentication secrets | Server only | `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` |

<h3>10.4 This Feature's Conventions</h3>

| Item | Convention Applied |
|------|-------------------|
| Component naming | PascalCase (`ArgumentForm`, `ArenaFeed`) |
| File organization | `src/components/arena/`, `src/app/debate/`, `src/app/` |
| State management | React `useState`, `useFormState` 또는 `useReducer` (서버 액션과 연동) |
| Error handling | 서버 액션에서 에러 객체 반환, 클라이언트에서 `useState`로 에러 메시지 관리 및 표시 |

---

<h2>11. Implementation Guide</h2>

<h3>11.1 File Structure</h3>

기존 파일 구조를 활용합니다.
- `src/app/debate/[id]/page.tsx`: 토론 상세 페이지
- `src/components/arena/ArgumentForm.tsx`: 댓글 입력 폼
- `src/components/arena/ArenaFeed.tsx`: 댓글 목록
- `src/app/actions.ts`: 서버 액션 (댓글 추가 로직)
- `src/lib/supabase/server.ts`: Supabase 서버 클라이언트

<h3>11.2 Implementation Order</h3>

1.  **데이터베이스 스키마 확인 및 수정**:
    *   `supabase/schema.sql` 또는 `reset_and_update.sql`에서 `comments` 테이블 존재 여부 및 구조 확인.
    *   필요 시 `comments` 테이블 생성 또는 수정 (user_id, debate_id, content 포함).
    *   Row Level Security(RLS) 정책 설정 (`auth.uid() = user_id`).
2.  **`src/app/actions.ts`에 댓글 추가 서버 액션 구현**:
    *   `createSupabaseServerClient`를 사용하여 Supabase 클라이언트를 가져옵니다.
    *   사용자 인증 상태를 확인합니다.
    *   댓글 내용과 토론 ID를 받아 유효성을 검사합니다.
    *   Supabase `insert` 쿼리를 사용하여 `comments` 테이블에 데이터를 추가합니다.
    *   성공 또는 실패에 따라 `{ data: Comment }` 또는 `{ error: string }`을 반환합니다.
    *   성공 시 `revalidatePath('/debate/[id]')` 또는 `revalidatePath('/debate/all')` 등을 호출하여 UI 캐시를 갱신합니다.
3.  **`src/components/arena/ArgumentForm.tsx` 수정**:
    *   댓글 내용을 위한 `textarea` 및 제출 버튼을 포함합니다.
    *   Next.js `useFormState` 훅을 사용하여 `actions.ts`의 `addComment` 서버 액션과 연동합니다.
    *   `useFormStatus` 훅을 사용하여 제출 중 로딩 상태를 표시하고, 버튼을 비활성화합니다.
    *   `addComment` 액션의 응답을 받아 성공 시 폼을 초기화하고, 실패 시 오류 메시지를 표시합니다.
4.  **`src/app/debate/[id]/page.tsx` 또는 `src/components/arena/ArenaFeed.tsx` 수정**:
    *   `page.tsx`에서 `ArgumentForm` 컴포넌트를 렌더링하고, 필요하다면 `ArenaFeed`에 새로운 댓글이 추가될 수 있도록 데이터를 다시 불러오거나 상태를 업데이트하는 로직을 추가합니다.
    *   `ArenaFeed.tsx`는 댓글 목록을 표시하며, 새로 추가된 댓글이 목록에 즉시 반영되도록 구현합니다. (옵티미스틱 업데이트 또는 `revalidatePath` 후 데이터 재요청)

---

<h2>Version History</h2>

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-06 | Initial draft | Gemini CLI |
